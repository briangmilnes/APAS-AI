//! Benchmark for Chapter 36: Multithreaded Quicksort Performance Comparison

use criterion::{black_box, criterion_group, criterion_main, BenchmarkId, Criterion};
use std::sync::Mutex;
use apas_ai::Chapter36::Chapter36::*;
use apas_ai::ArraySeqMtPer::ArraySeqMtPer::*;

fn create_sorted_input(size: usize) -> ArrayMtPerS<i32> {
    let data: Vec<Mutex<i32>> = (0..size as i32).map(|x| Mutex::new(x)).collect();
    ArrayMtPerS::from_vec(data)
}

fn create_reverse_sorted_input(size: usize) -> ArrayMtPerS<i32> {
    let data: Vec<Mutex<i32>> = (0..size as i32).rev().map(|x| Mutex::new(x)).collect();
    ArrayMtPerS::from_vec(data)
}

fn create_random_input(size: usize) -> ArrayMtPerS<i32> {
    use rand::{thread_rng, Rng};
    let mut rng = thread_rng();
    let data: Vec<Mutex<i32>> = (0..size).map(|_| Mutex::new(rng.gen_range(0..size as i32))).collect();
    ArrayMtPerS::from_vec(data)
}

fn bench_quicksort_pivot_first(c: &mut Criterion) {
    let mut group = c.benchmark_group("quicksort_pivot_first");
    
    for &size in &[100, 1000, 5000] {
        // Sorted input (worst case for first pivot)
        group.bench_with_input(
            BenchmarkId::new("sorted", size),
            &size,
            |b, &size| {
                let input = create_sorted_input(size);
                b.iter(|| quicksort_pivot_first(black_box(&input)))
            },
        );
        
        // Reverse sorted input
        group.bench_with_input(
            BenchmarkId::new("reverse_sorted", size),
            &size,
            |b, &size| {
                let input = create_reverse_sorted_input(size);
                b.iter(|| quicksort_pivot_first(black_box(&input)))
            },
        );
        
        // Random input
        group.bench_with_input(
            BenchmarkId::new("random", size),
            &size,
            |b, &size| {
                let input = create_random_input(size);
                b.iter(|| quicksort_pivot_first(black_box(&input)))
            },
        );
    }
    
    group.finish();
}

fn bench_quicksort_pivot_median_of_three(c: &mut Criterion) {
    let mut group = c.benchmark_group("quicksort_pivot_median_of_three");
    
    for &size in &[100, 1000, 5000] {
        // Sorted input (should perform better than first pivot)
        group.bench_with_input(
            BenchmarkId::new("sorted", size),
            &size,
            |b, &size| {
                let input = create_sorted_input(size);
                b.iter(|| quicksort_pivot_median_of_three(black_box(&input)))
            },
        );
        
        // Reverse sorted input
        group.bench_with_input(
            BenchmarkId::new("reverse_sorted", size),
            &size,
            |b, &size| {
                let input = create_reverse_sorted_input(size);
                b.iter(|| quicksort_pivot_median_of_three(black_box(&input)))
            },
        );
        
        // Random input
        group.bench_with_input(
            BenchmarkId::new("random", size),
            &size,
            |b, &size| {
                let input = create_random_input(size);
                b.iter(|| quicksort_pivot_median_of_three(black_box(&input)))
            },
        );
    }
    
    group.finish();
}

fn bench_quicksort_pivot_random(c: &mut Criterion) {
    let mut group = c.benchmark_group("quicksort_pivot_random");
    
    for &size in &[100, 1000, 5000] {
        // Sorted input (should perform well with random pivot)
        group.bench_with_input(
            BenchmarkId::new("sorted", size),
            &size,
            |b, &size| {
                let input = create_sorted_input(size);
                b.iter(|| quicksort_pivot_random(black_box(&input)))
            },
        );
        
        // Reverse sorted input
        group.bench_with_input(
            BenchmarkId::new("reverse_sorted", size),
            &size,
            |b, &size| {
                let input = create_reverse_sorted_input(size);
                b.iter(|| quicksort_pivot_random(black_box(&input)))
            },
        );
        
        // Random input
        group.bench_with_input(
            BenchmarkId::new("random", size),
            &size,
            |b, &size| {
                let input = create_random_input(size);
                b.iter(|| quicksort_pivot_random(black_box(&input)))
            },
        );
    }
    
    group.finish();
}

fn bench_quicksort_comparison(c: &mut Criterion) {
    let mut group = c.benchmark_group("quicksort_comparison");
    let size = 1000;
    
    // Compare all three variants on sorted input
    let sorted_input = create_sorted_input(size);
    group.bench_function("first_pivot_sorted", |b| {
        b.iter(|| quicksort_pivot_first(black_box(&sorted_input)))
    });
    group.bench_function("median_of_three_sorted", |b| {
        b.iter(|| quicksort_pivot_median_of_three(black_box(&sorted_input)))
    });
    group.bench_function("random_pivot_sorted", |b| {
        b.iter(|| quicksort_pivot_random(black_box(&sorted_input)))
    });
    
    // Compare all three variants on random input
    let random_input = create_random_input(size);
    group.bench_function("first_pivot_random", |b| {
        b.iter(|| quicksort_pivot_first(black_box(&random_input)))
    });
    group.bench_function("median_of_three_random", |b| {
        b.iter(|| quicksort_pivot_median_of_three(black_box(&random_input)))
    });
    group.bench_function("random_pivot_random", |b| {
        b.iter(|| quicksort_pivot_random(black_box(&random_input)))
    });
    
    group.finish();
}

criterion_group!(
    benches,
    bench_quicksort_pivot_first,
    bench_quicksort_pivot_median_of_three,
    bench_quicksort_pivot_random,
    bench_quicksort_comparison
);
criterion_main!(benches);
